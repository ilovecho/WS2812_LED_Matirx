<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ëª¨ë°”ì¼ìš© JSON Form í¸ì§‘ê¸°</title>
  <style>
    /* ê³µí†µ ë°°ê²½Â·í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (WS2812 ì˜ˆì œì™€ ë™ì¼) */
    body {
      margin: 0;
      padding: 1rem;
      font-family: sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    h2 {
      margin: 0;
      font-size: 1.2rem;
      text-align: center;
      color: #5af;
    }
    /* í¼ ì»¨í…Œì´ë„ˆ */
    #formContainer {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    #formContainer label {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
    }
    #formContainer input {
      margin-top: 0.25rem;
      padding: 0.5rem;
      font-size: 1rem;
      background: #222;
      color: #eee;
      border: 1px solid #444;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }
    #formContainer input:focus {
      outline: 2px solid #5af;
    }
    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    button {
      padding: 0.75rem;
      font-size: 1rem;
      background: #5af;
      color: #111;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      box-sizing: border-box;
    }
    button:active {
      background: #48c;
    }
    button:focus {
      outline: 2px solid #5af;
    }
    /* JSON textarea & ê´€ë¦¬ ë²„íŠ¼ ìˆ¨ê¹€ (ëª¨ë°”ì¼ ì „ìš©) */
    #jsonInput,
    #loadBtn,
    #saveBtn {
      display: none;
    }
  </style>
</head>
<body>
  <h2>ì„¤ì •ê°’ ìˆ˜ì •</h2>

  <div id="formContainer">
    <!-- buildForm()ê°€ label+inputì„ ì‚½ì… -->
  </div>
  
  <button id="sendBtn">ğŸš€ ì„œë²„ë¡œ ì „ì†¡</button>

  <!-- ê°œë°œìš© JSON ê´€ë¦¬ ìš”ì†Œ: ëª¨ë°”ì¼ì—ì„  ìˆ¨ê¹€ -->
  <textarea id="jsonInput" rows="10"></textarea>
  <button id="loadBtn">JSON â†’ í¼ ì¬ìƒì„±</button>
  <button id="saveBtn">í¼ â†’ JSON ì €ì¥</button>

  <script>
    const jsonInput     = document.getElementById('jsonInput');
    const loadBtn       = document.getElementById('loadBtn');
    const saveBtn       = document.getElementById('saveBtn');
    const sendBtn       = document.getElementById('sendBtn');
    const formContainer = document.getElementById('formContainer');

    function buildForm(data) {
      formContainer.innerHTML = '';
      Object.entries(data).forEach(([key, value]) => {
        const label = document.createElement('label');
        label.textContent = key;
        const input = document.createElement('input');
        input.id    = key + 'Input';
        input.name  = key;
        if (typeof value === 'number') {
          input.type  = 'number';
          input.value = value;
        } else {
          input.type  = 'text';
          input.value = value == null ? '' : value;
        }
        label.appendChild(input);
        formContainer.appendChild(label);
      });
    }

    async function loadSystemConfig() {
      const payload = { func: 'getcfg' };
      try {
        const res  = await fetch('/ctl', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const data = await res.json();
        jsonInput.value = JSON.stringify(data, null, 2);
        buildForm(data);
      } catch (err) {
        alert('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:\n' + err);
      }
    }

    sendBtn.addEventListener('click', async () => {
      const payload = { func: 'setcfg' };
      formContainer.querySelectorAll('input').forEach(input => {
        let v = input.value;
        if (input.type === 'number') v = v === '' ? null : Number(v);
        payload[input.name] = v;
      });
      try {
        const res = await fetch('/ctl', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        await loadSystemConfig();
      } catch (err) {
        alert('ì „ì†¡ ì‹¤íŒ¨:\n' + err);
      }
    });

    window.addEventListener('DOMContentLoaded', loadSystemConfig);
  </script>
</body>
</html>
